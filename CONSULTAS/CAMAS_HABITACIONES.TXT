
SELECT T935.C935CENT,PLANTA,HABITACION,NOMBRECAMA,ESTADO,
		SERVIPRO,
		T937.C937HOPR,
		T937.C937SECP,
		(CASE  WHEN T139.C139NHIS IS NOT NULL THEN '1' ELSE '0' END) AS ENPREADMISION,
		T937.SERVIRES,
		T937.C937HORE,
		T937.C937SECR,
		(CASE  WHEN T937.C937TIAS IS NOT NULL THEN T937.C937TIAS ELSE '' END) AS TIPOASISTENCIA,
		(CASE  WHEN T903.HCASENO IS NOT NULL THEN T903.HCASENO ELSE '' END) AS NUMEROCASO,
		T937.HNAME,
		(CASE  WHEN T971.SEXO IS NOT NULL THEN T971.SEXO ELSE '' END) AS SEXO,
		T937.C937STA2,
		T937.C937ALPR,
		(CASE  WHEN T903.HPATSTAT IS NOT NULL THEN T903.HPATSTAT ELSE '' END) AS HPATSTAT,
		T937.HBEDSTAT
		
		
		
FROM
(
select 	CAMAS.C935ABUE AS PLANTA,
		CAMAS.C936PADR AS HABITACION,
		CAMAS.HBEDNO AS NOMBRECAMA,
		CAMAS.HBEDSTAT AS ESTADO
from (
	SELECT 	CAMAS.C935ABUE AS PLANTA, 
			CAMAS.C936PADR AS HABITACION
			--CAMAS.HBEDNO AS NOMBRECAMA
			--'' AS ESTADO
	FROM SQLEXP.TH937 CAMAS
	INNER JOIN SQLEXP.TH936 HABITACIONES 
		ON CAMAS.C935ABUE = HABITACIONES.C935PADR AND CAMAS.C936PADR=HABITACIONES.HRMNO			
	GROUP BY CAMAS.C935ABUE,CAMAS.C936PADR
	HAVING COUNT(CAMAS.HBEDNO) < 2
	ORDER BY PLANTA,HABITACION ASC) as HABITACIONES
INNER JOIN SQLEXP.TH937 CAMAS ON CAMAS.C935ABUE = HABITACIONES.PLANTA AND CAMAS.C936PADR=HABITACIONES.HABITACION
UNION  
SELECT 	CAMAS.C935ABUE AS PLANTA,
		CAMAS.C936PADR AS HABITACION,
		CAMAS.HBEDNO AS NOMBRECAMA,
		CAMAS.HBEDSTAT AS ESTADO
FROM SQLEXP.TH937 CAMAS
INNER JOIN SQLEXP.TH936 HABITACIONES ON CAMAS.C935ABUE = HABITACIONES.C935PADR AND CAMAS.C936PADR=HABITACIONES.HRMNO
WHERE CAMAS.HBEDSTAT IN ('A','B','C','X','Z')
) AS CAMAS
INNER JOIN SQLEXP.TH935 T935 ON  T935.HNURSTA= CAMAS.PLANTA
LEFT JOIN SQLEXP.TH937 T937 ON T937.C935ABUE=CAMAS.PLANTA AND T937.C936PADR=CAMAS.HABITACION AND T937.HBEDNO=CAMAS.NOMBRECAMA
LEFT JOIN SQLEXP.TH139 T139 ON T139.C139CUEN = CAMAS.PLANTA AND T139.C139CHAB = CAMAS.HABITACION AND T139.C139CCAM = CAMAS.NOMBRECAMA
LEFT JOIN SQLEXP.TH971 T971 ON T971.NHISTOR1 = T937.C937NHIS 
LEFT JOIN SQLEXP.TH903 T903 ON T937.HCASENO = T903.HCASENO
WHERE 	T935.C935CENT='1' 
	-- AND 
	--	T935.C935HODO='H'  
		
/* GROUP BY T935.C935CENT,PLANTA,HABITACION,NOMBRECAMA,ESTADO,T937.SERVIPRO,
		T937.C937HORE,
		T937.C937SECP*/  
ORDER BY PLANTA,HABITACION
